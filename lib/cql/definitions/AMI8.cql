
using QDM version '5.0.2'

codesystem "LOINC:2.46": 'urn:oid:2.16.840.1.113883.6.1' version 'urn:hl7:version:2.46'

codesystem "SNOMEDCT:2016-03": 'urn:oid:2.16.840.1.113883.6.96' version 'urn:hl7:version:2016-03'

valueset "ONC Administrative Sex": 'urn:oid:2.16.840.1.113762.1.4.1' 

valueset "Race": 'urn:oid:2.16.840.1.114222.4.11.836' 

valueset "Ethnicity": 'urn:oid:2.16.840.1.114222.4.11.837' 

valueset "Payer": 'urn:oid:2.16.840.1.114222.4.11.3591' 

valueset "Cardiopulmonary arrest": 'urn:oid:2.16.840.1.113883.3.666.5.748' 

valueset "Electrocardiogram (ECG)": 'urn:oid:2.16.840.1.113883.3.666.5.735' 

valueset "Emergency Department Visit": 'urn:oid:2.16.840.1.113883.3.117.1.7.1.292' 

valueset "Encounter Inpatient": 'urn:oid:2.16.840.1.113883.3.666.5.307' 

valueset "Fibrinolytic Therapy": 'urn:oid:2.16.840.1.113883.3.666.5.736' 

valueset "Aortic balloon pump insertion": 'urn:oid:2.16.840.1.113883.3.666.5.1151' 

valueset "Endotracheal Intubation": 'urn:oid:2.16.840.1.113762.1.4.1045.69' 

valueset "PCI": 'urn:oid:2.16.840.1.113762.1.4.1045.67' 

valueset "Ventricular Assist Device placement": 'urn:oid:2.16.840.1.113883.3.666.5.3015' 

valueset "Ambulatory surgical center": 'urn:oid:2.16.840.1.113883.3.666.5.687' 

valueset "Transfer From Emergency Department (ED) Locations": 'urn:oid:2.16.840.1.113883.3.666.5.3006' 

valueset "Transfer From Inpatient": 'urn:oid:2.16.840.1.113883.3.666.5.3013' 

valueset "Transfer From Outpatient": 'urn:oid:2.16.840.1.113883.3.67.1.101.950' 

valueset "STEMI Exclusions": 'urn:oid:2.16.840.1.113762.1.4.1045.36' 

valueset "Acute Myocardial Infarction (AMI)": 'urn:oid:2.16.840.1.113883.3.666.5.3011' 

valueset "Acute or Evolving MI": 'urn:oid:2.16.840.1.113883.3.666.5.3022' 

code "Birthdate": '21112-8' from "LOINC:2.46" display 'Birth date'

code "Dead": '419099009' from "SNOMEDCT:2016-03" display 'Dead'

parameter "Measurement Period" Interval<DateTime>






    where Encounter.lengthOfStay <= 120 days
      		and Encounter.relevantPeriod ends during "Measurement Period"

    with "Inpatient Encounters" Inpatient
    such that Emergency.relevantPeriod ends 1 hours or less before start of Inpatient.relevantPeriod

  not exists (
    ["Encounter, Not Performed": "Emergency Department Visit"] NoED
      with "Inpatient Encounters" Encounter
        such that NoED.relevantPeriod ends 1 hours or less before Encounter.relevantPeriod
  )

where Encounter.principalDiagnosis in "Acute Myocardial Infarction (AMI)"

"Encounter Principal Diagnosis of AMI"

 "Inpatient Encounters" Inpatient,
 "Emergency Department Encounter" Emergency
    where 
    ((Encounter.relevantPeriod starts 1 day or less before start of Emergency.relevantPeriod)
    and (Encounter.relevantPeriod starts 1 day or less before start of Inpatient.relevantPeriod))
    or
    (Encounter.relevantPeriod starts 1 day or less before start of Inpatient.relevantPeriod and Emergency is null)


let
  ECG: Coalesce(
   Last("Electrocardiogram Diagnostic" ECG
where ECG.relevantPeriod starts 1 hour or less before Hospitalization(Encounter)
sort by start of ECG.relevantPeriod),

First("Electrocardiogram Diagnostic" ECG
 where ECG.relevantPeriod starts during Hospitalization(Encounter)
sort by start of ECG.relevantPeriod)),

  PCI: First("PCI Procedure" PCI
where PCI.relevantPeriod starts after start of Hospitalization(Encounter)
sort by start of PCI.relevantPeriod),

  FT: First("Fibrinolytic Therapy" FT
where FT.relevantPeriod starts after start of Hospitalization(Encounter)
sort by start of FT.relevantPeriod)

with "Inpatient Encounters" IP
such that PCI.relevantPeriod starts 90 minutes or less after start of IP.relevantPeriod

"PCI ED IP"

 or exists ("Procedure Except IP")

where ASC.admissionSource in "Ambulatory surgical center"

or exists ["Encounter, Performed": "Transfer From Outpatient"] Outpatient
where Outpatient.admissionSource in "Transfer From Outpatient"

or exists ["Encounter, Performed": "Transfer From Emergency Department (ED) Locations"] ED
 where ED.admissionSource in "Transfer From Emergency Department (ED) Locations"
 
 or exists  ["Encounter, Performed": "Transfer From Inpatient"] Inpatient
 where Inpatient.admissionSource in "Transfer From Inpatient")

     where AgeInYearsAt(start of Encounter.relevantPeriod) >= 18

with "Emergency Department Encounter" ED
such that RecentECG.relevantPeriod starts 1 hour or less before start of ED.relevantPeriod
sort by start of RecentECG.relevantPeriod)}

with "Emergency Department Encounter" ED
such that FirstECG.relevantPeriod starts 1 hour or less before start of ED.relevantPeriod
sort by start of FirstECG.relevantPeriod)}

with "Inpatient Encounters" IP
such that FirstECG.relevantPeriod starts 1 hour or less before start of IP.relevantPeriod
sort by start of FirstECG.relevantPeriod)}

with  "Emergency Department Encounter" Encounter 
such that PCI.incisionDatetime 1440 minutes or less after start of  Encounter.relevantPeriod
    sort by start of PCI.relevantPeriod)

with  "Emergency Department Encounter" Encounter 
    such that PCI.incisionDatetime  1440 minutes or less after start of Encounter.relevantPeriod
  sort by start of PCI.relevantPeriod)


  ( ["Procedure, Performed": "Endotracheal Intubation"]
union ["Procedure, Performed": "Aortic balloon pump insertion"]
union ["Procedure, Performed": "Ventricular Assist Device placement"]))


  "No Emergency Department Encounter"  
    and exists ("Most Recent ECG") or exists ("First ECG Inpatient")

where (ECG.result as Code) in "Acute or Evolving MI" and ECG.result is not null

  where not ((ECG.result as Code) in "STEMI Exclusions") and ECG.code is not null

["Medication, Administered": "Fibrinolytic Therapy"] Fib,
["Encounter, Performed":"Emergency Department Visit"] ED
where PCI.relevantPeriod starts after start of Fib.relevantPeriod
and Fib.relevantPeriod starts after start of ED.relevantPeriod

["Medication, Administered": "Fibrinolytic Therapy"] Fib,
"Inpatient Encounters" IP
where PCI.relevantPeriod starts after start of Fib.relevantPeriod
and Fib.relevantPeriod during IP.relevantPeriod

  exists ("PCI Inpatient") 
    and "No Emergency Department Encounter"
    and not exists ("PCI Med IP")


with "Emergency Department Encounter" ED
such that PCI.relevantPeriod starts 90 minutes or less after start of ED.relevantPeriod


or exists "Procedure Reason for No PCI"

with "Emergency Department Encounter" Encounter
 such that Procedure.relevantPeriod starts 90 minutes or less after start of Encounter.relevantPeriod

with "Inpatient Encounters" Encounter
 such that( Procedure.relevantPeriod starts 90 minutes or less after start of Encounter.relevantPeriod)
 /*"No Emergency Department Encounter"*/


["Procedure, Performed": "Endotracheal Intubation"]
union ["Procedure, Performed": "Aortic balloon pump insertion"]
union ["Procedure, Performed": "Ventricular Assist Device placement"])

    where AgeInYearsAt(start of Encounter.relevantPeriod) >= 18
      and Encounter.principalDiagnosis in "Acute Myocardial Infarction (AMI)"



with ["Encounter, Performed": "Emergency Department Visit"] ed 
with "Comfort Measures" comf 
 such that ed.relevantPeriod ends 1 hour or less before start of inp.relevantPeriod 
and comf.relevantPeriod starts during ed.relevantPeriod

    ["Encounter, Performed": "Emergency Department Visit"] EDVisit
      where EDVisit.relevantPeriod ends 1 hour or less before start of Encounter.relevantPeriod
  )) X
    return if X is null then Encounter.relevantPeriod
      else Interval[start of X.relevantPeriod, end of Encounter.relevantPeriod]
